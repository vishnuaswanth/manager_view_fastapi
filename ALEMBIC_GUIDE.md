# Alembic Database Migration Guide

This project uses Alembic for database schema migrations. Alembic automatically detects changes in your SQLModel definitions and generates migration scripts.

## Initial Setup (One-Time)

### 1. Install Alembic

```bash
pip3 install alembic
```

Or if using a virtual environment:
```bash
source venv/bin/activate  # Activate your venv first
pip install alembic
```

### 2. Verify Installation

```bash
alembic --version
```

Expected output: `alembic 1.x.x` (or higher)

## Configuration

The Alembic configuration is already set up and includes:

- **`alembic.ini`**: Main configuration file
- **`alembic/env.py`**: Environment configuration (auto-detects MODE from config.ini)
- **`alembic/script.py.mako`**: Template for new migrations
- **`alembic/versions/`**: Directory for migration files

### How It Works

Alembic automatically:
1. Reads your MODE setting from `code/config.ini`
2. Connects to the correct database (SQLite for DEBUG, MSSQL for PRODUCTION)
3. Compares your SQLModel definitions with the actual database schema
4. Generates migration scripts with upgrade/downgrade logic

## Creating Your First Migration

### Step 1: Generate Migration for Bench Allocation Fields

Since you've already added `BenchAllocationCompleted` and `BenchAllocationCompletedAt` to the `AllocationExecutionModel`, run:

```bash
alembic revision --autogenerate -m "Add bench allocation tracking fields"
```

This will:
- Detect the two new fields in `AllocationExecutionModel`
- Create a migration file in `alembic/versions/`
- Generate both `upgrade()` and `downgrade()` functions

**Expected Output:**
```
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added column 'allocationexecutionmodel.BenchAllocationCompleted'
INFO  [alembic.autogenerate.compare] Detected added column 'allocationexecutionmodel.BenchAllocationCompletedAt'
  Generating /path/to/alembic/versions/abc123_add_bench_allocation_tracking_fields.py ...  done
```

### Step 2: Review the Generated Migration

Open the generated file in `alembic/versions/` and verify it looks correct:

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('allocationexecutionmodel',
                  sa.Column('BenchAllocationCompleted', sa.Boolean(), nullable=False))
    op.add_column('allocationexecutionmodel',
                  sa.Column('BenchAllocationCompletedAt', sa.DateTime(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('allocationexecutionmodel', 'BenchAllocationCompletedAt')
    op.drop_column('allocationexecutionmodel', 'BenchAllocationCompleted')
    # ### end Alembic commands ###
```

### Step 3: Apply the Migration

```bash
alembic upgrade head
```

This will:
- Run the `upgrade()` function
- Add the two new columns to your database
- Update the `alembic_version` table to track which migrations have been applied

**Expected Output:**
```
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> abc123, Add bench allocation tracking fields
```

### Step 4: Verify Migration

Check your database to confirm the columns were added:

**SQLite:**
```bash
sqlite3 code/test.db "PRAGMA table_info(allocationexecutionmodel);" | grep BenchAllocation
```

**MSSQL:**
```sql
SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'allocationexecutionmodel'
  AND COLUMN_NAME LIKE 'BenchAllocation%';
```

## Common Alembic Commands

### Check Current Migration Status

```bash
alembic current
```

Shows which migration is currently applied.

### View Migration History

```bash
alembic history --verbose
```

Shows all migrations and their status.

### Upgrade to Latest Version

```bash
alembic upgrade head
```

Applies all pending migrations.

### Downgrade One Version

```bash
alembic downgrade -1
```

Reverts the last migration.

### Downgrade to Specific Version

```bash
alembic downgrade abc123
```

Reverts to migration with revision ID `abc123`.

### Generate New Migration (Auto-detect Changes)

```bash
alembic revision --autogenerate -m "Description of changes"
```

Automatically detects model changes and generates migration.

### Create Empty Migration (Manual)

```bash
alembic revision -m "Custom migration"
```

Creates an empty migration file for manual SQL.

## Workflow for Future Changes

Whenever you modify SQLModel definitions:

1. **Make changes to models** in `code/logics/db.py`

2. **Generate migration:**
   ```bash
   alembic revision --autogenerate -m "Describe your change"
   ```

3. **Review the generated migration file** in `alembic/versions/`

4. **Test in DEBUG mode first:**
   ```bash
   # Ensure MODE=DEBUG in code/config.ini
   alembic upgrade head
   ```

5. **Test your application** to ensure migration worked

6. **Apply to PRODUCTION:**
   ```bash
   # Change MODE=PRODUCTION in code/config.ini
   alembic upgrade head
   ```

## Database-Specific Notes

### SQLite (DEBUG Mode)

- Alembic detects `MODE=DEBUG` and uses SQLite
- Database file: `code/test.db`
- Some operations require table recreation (SQLite limitation)
- Alembic handles this automatically

### MSSQL (PRODUCTION Mode)

- Alembic detects `MODE=PRODUCTION` and uses MSSQL
- Uses connection string from `code/config.ini`
- Requires proper database permissions (ALTER TABLE)
- Transactions are used for safety

## Migration Best Practices

### 1. Always Review Auto-Generated Migrations

Alembic's auto-detection is good but not perfect. Always review:
- Column types match your expectations
- Nullable/not-nullable settings are correct
- Default values are handled properly
- Indexes are created/dropped as needed

### 2. Test Migrations in DEBUG Mode First

```bash
# Step 1: Set MODE=DEBUG in config.ini
# Step 2: Run migration
alembic upgrade head
# Step 3: Test your application
# Step 4: If issues, rollback
alembic downgrade -1
```

### 3. Backup Production Database Before Migrating

```bash
# For MSSQL - use SQL Server Management Studio or:
sqlcmd -S server -d database -Q "BACKUP DATABASE..."
```

### 4. Use Descriptive Migration Messages

Good:
```bash
alembic revision --autogenerate -m "Add bench allocation tracking fields to prevent duplicates"
```

Bad:
```bash
alembic revision --autogenerate -m "update"
```

### 5. Keep Migrations in Version Control

Commit migration files to git:
```bash
git add alembic/versions/*.py
git commit -m "Add migration for bench allocation tracking"
```

## Troubleshooting

### "No changes in schema detected"

**Cause:** Alembic didn't detect any changes between your models and database.

**Solutions:**
- Ensure you imported all models in `alembic/env.py`
- Check that your model changes are saved
- Verify database connection is correct

### "Multiple heads found"

**Cause:** Conflicting migrations from different branches.

**Solution:**
```bash
alembic merge heads -m "Merge migrations"
alembic upgrade head
```

### "Target database is not up to date"

**Cause:** Database has uncommitted migrations.

**Solution:**
```bash
# Check status
alembic current
alembic history

# Upgrade to latest
alembic upgrade head
```

### "Can't locate revision identified by 'abc123'"

**Cause:** Migration file doesn't exist.

**Solution:**
- Check `alembic/versions/` directory
- Ensure migration files are in version control
- Pull latest migrations from git

## Migration Files Location

All migration files are stored in:
```
alembic/versions/
â”œâ”€â”€ abc123_add_bench_allocation_tracking_fields.py
â”œâ”€â”€ def456_next_migration.py
â””â”€â”€ ...
```

Each file contains:
- **Revision ID**: Unique identifier
- **Dependency chain**: Links to previous migration
- **upgrade()**: SQL to apply changes
- **downgrade()**: SQL to revert changes

## Rollback Strategy

If a migration causes issues in production:

1. **Immediate rollback:**
   ```bash
   alembic downgrade -1
   ```

2. **Restart application** (uses old schema)

3. **Fix the migration** in a new migration file

4. **Test thoroughly** in DEBUG mode

5. **Re-apply** when fixed

## Integration with CI/CD

For automated deployments:

```bash
# In your deployment script:
alembic upgrade head && python3 -m uvicorn code.main:app
```

This ensures migrations run before starting the application.

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLModel Documentation](https://sqlmodel.tiangolo.com/)
- [SQLAlchemy Migration Guide](https://docs.sqlalchemy.org/en/14/core/metadata.html)

## Summary

| Action | Command |
|--------|---------|
| Install Alembic | `pip3 install alembic` |
| Generate migration | `alembic revision --autogenerate -m "message"` |
| Apply migrations | `alembic upgrade head` |
| Rollback one migration | `alembic downgrade -1` |
| Check status | `alembic current` |
| View history | `alembic history` |

Your Alembic setup is complete and ready to use! ðŸš€
