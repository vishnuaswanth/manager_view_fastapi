<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2 Data Flow Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .header h1 { margin: 0 0 10px 0; font-size: 28px; }
        .header p { margin: 0; opacity: 0.9; }
        .diagram-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .diagram-card h3 {
            margin: 0 0 20px 0;
            color: #333;
            border-bottom: 2px solid #4ade80;
            padding-bottom: 10px;
        }
        .mermaid { text-align: center; }
        .nav { margin-bottom: 20px; }
        .nav a {
            display: inline-block;
            padding: 10px 20px;
            background: #e0e0e0;
            color: #333;
            text-decoration: none;
            border-radius: 6px;
            margin-right: 10px;
        }
        .nav a:hover { background: #d0d0d0; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="data_flow.html">Data Flow</a>
        <a href="allocation.html">Allocation</a>
        <a href="system_design.html">System Design</a>
    </div>

    <div class="header">
        <h1>Data Flow Diagrams</h1>
        <p>V2 Weekly Capacity & Multi-Group Resource Tracking - Data Flow Architecture</p>
    </div>

    <div class="diagram-card">
        <h3>1. High-Level Data Flow</h3>
<pre class="mermaid">
graph TB
    ROSTER[Roster File] --> UPLOAD[Upload Router]
    FORECAST[Forecast File] --> UPLOAD
    CONFIG[Month Config] --> UPLOAD
    UPLOAD --> MIGRATION[Data Migration]
    MIGRATION --> RESOURCE[ResourceModel]
    WEEKGEN[Week Config Generator] --> WEEKCONFIG[WeekConfiguration]
    RESOURCE --> ASSIGN[WeeklyAssignments]
    WEEKCONFIG --> ASSIGN
    ASSIGN --> SUMMARY[MonthlySummary]
    SUMMARY --> POWERBI[PowerBI]
    SUMMARY --> DASHBOARD[JS Dashboard]
    SUMMARY --> EXCEL[Excel Export]
</pre>
    </div>

    <div class="diagram-card">
        <h3>2. Capacity Calculation Flow</h3>
<pre class="mermaid">
graph LR
    PROD[Production Percent] --> CALC[Calculate Capacity]
    DAYS[Working Days] --> CALC
    HOURS[Work Hours] --> CALC
    SHRINK[Shrinkage] --> CALC
    CPH[Target CPH] --> CALC
    CALC --> WEEKLY[Weekly Capacity]
    WEEKLY --> MONTHLY[Monthly Capacity]
</pre>
    </div>

    <div class="diagram-card">
        <h3>3. Report Generation Flow</h3>
<pre class="mermaid">
graph TD
    START[Generate Report] --> GET_DATA[Get Summary and Assignments]
    GET_DATA --> SPLIT[Split Actual vs Placeholder]
    SPLIT --> TIERS[Calculate Tier Breakdown]
    TIERS --> FORMAT{Output Format}
    FORMAT -->|PowerBI| FLAT[Flatten to Table]
    FORMAT -->|Dashboard| NEST[Nest to JSON]
    FLAT --> PBI_OUT[PowerBI Report]
    NEST --> JS_OUT[Dashboard JSON]
</pre>
    </div>

    <div class="diagram-card">
        <h3>4. Data Migration Flow - V1 to V2</h3>
<pre class="mermaid">
graph TD
    START[Start Migration] --> CREATE[Create V2 Tables]
    CREATE --> SEED1[Seed Capacity Tiers]
    SEED1 --> SEED2[Seed Policies]
    SEED2 --> READ[Read Existing Roster]
    READ --> MAP[Map Fields]
    MAP --> SAVE1[Save Resources]
    SAVE1 --> ALLOC[Read Allocations]
    ALLOC --> CONVERT[Convert to Weekly]
    CONVERT --> SAVE2[Save Assignments]
    SAVE2 --> VERIFY[Verify Integrity]
    VERIFY --> DONE[Migration Complete]
</pre>
    </div>

    <div class="diagram-card">
        <h3>5. Week Configuration Generation</h3>
<pre class="mermaid">
graph TD
    START[Start] --> INPUT[Input Month and Year]
    INPUT --> GET[Get MonthConfiguration]
    GET --> CALC[Calculate ISO Weeks]
    CALC --> LOOP[For Each Week]
    LOOP --> CREATE[Create WeekConfig]
    CREATE --> DATES[Set Start and End Dates]
    DATES --> PARAMS[Set Working Days etc]
    PARAMS --> SAVE[Save to Database]
    SAVE --> END[Done]
</pre>
    </div>

    <div class="diagram-card">
        <h3>6. Data Transformation Pipeline</h3>
<pre class="mermaid">
graph LR
    subgraph Input
        ROSTER[Roster Excel]
        FORECAST[Forecast Excel]
    end
    subgraph Transform
        PARSE[Parse Files]
        VALIDATE[Validate Data]
        NORMALIZE[Normalize Fields]
    end
    subgraph Store
        RESOURCE_DB[ResourceModel]
        FORECAST_DB[ForecastModel]
        ASSIGN_DB[WeeklyAssignment]
    end
    subgraph Output
        POWERBI_OUT[PowerBI Report]
        DASHBOARD_OUT[Dashboard JSON]
    end
    ROSTER --> PARSE
    FORECAST --> PARSE
    PARSE --> VALIDATE
    VALIDATE --> NORMALIZE
    NORMALIZE --> RESOURCE_DB
    NORMALIZE --> FORECAST_DB
    RESOURCE_DB --> ASSIGN_DB
    ASSIGN_DB --> POWERBI_OUT
    ASSIGN_DB --> DASHBOARD_OUT
</pre>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
</body>
</html>
